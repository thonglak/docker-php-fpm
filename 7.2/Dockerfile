#
# This file is auto-generated by update.sh
#
# @package php/alpine/fpm
# @author  Yannoff <https://github.com/yannoff>
# @license MIT
#

FROM php:7.2-fpm-alpine

ARG PHP_EXTS="pdo_mysql pdo_pgsql intl opcache bcmath"

LABEL author="Yannoff <https://github.com/yannoff>" \
      description="PHP-FPM with basic php extensions and composer" \
      license="MIT"

ENV MUSL_LOCPATH /usr/local/share/i18n/locales/musl

# Fix ICONV library implementation
# @see https://github.com/docker-library/php/issues/240
ENV LD_PRELOAD /usr/local/lib/preloadable_libiconv.so

COPY --from=mlocati/php-extension-installer /usr/bin/install-php-extensions /usr/bin/

# Install basic packages & PHP extensions
RUN \
    REMOTE_SCRIPTS_URL=https://raw.githubusercontent.com/yannoff/alpine-tools/master/bin; \
    \
    apk add --update bash git; \
    \
    install-php-extensions ${PHP_EXTS} >/dev/null; \
    \
    # Install support for locales
    # @see https://github.com/gliderlabs/docker-alpine/issues/144
    curl -s ${REMOTE_SCRIPTS_URL}/install-locales | bash; \
    \
    # Fix ICONV library implementation
    # @see https://github.com/docker-library/php/issues/240
    curl -s ${REMOTE_SCRIPTS_URL}/rebuild-iconv-lib | bash; \
    \
    # Install composer & offenbach
    curl -s ${REMOTE_SCRIPTS_URL}/install-composer | bash; \
    \
    # Cleanup:
    # - purge APK repository cache
    # - remove PHP source tarballs
    rm -v /var/cache/apk/*; \
    rm -rf /usr/src/*;
